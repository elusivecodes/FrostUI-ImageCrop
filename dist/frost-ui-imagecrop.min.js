!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("@fr0st/ui"),require("@fr0st/query")):"function"==typeof define&&define.amd?define(["exports","@fr0st/ui","@fr0st/query"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).UI=t.UI||{},t.UI,t.fQuery)}(this,(function(t,i,e){"use strict";class s extends i.BaseComponent{constructor(t,i){super(t,i),this._render(),this._events(),this._img=new Image,this._reader=new FileReader}dispose(){e.remove(this._outerContainer),this._outerContainer=null,this._container=null,this._resize=null,this._canvas=null,this._context=null,this._img=null,super.dispose()}getBounds(){const t=this._previewWidth/this._zoom,i=this._previewHeight/this._zoom,e=this._canvasWidth-this._offsetX-t/2,s=this._canvasHeight-this._offsetY-i/2;return[e,s,e+t,s+i]}getZoom(){return this._zoom}rotate(t=90){this._options.rotate&&0!==t&&(this._updateRotation(t),this._clampZoom(),this._updatePreviewCanvas(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop"))}setBounds(t,i,s,o){const h=s-t,n=o-i;this._options.resize?this._resizePreview(h*this._zoom,n*this._zoom):this._options.zoom&&(this._zoom=Math.max(this._previewWidth/h,this._previewHeight/n)),this._offsetX=this._canvasWidth-(t+h/2),this._offsetY=this._canvasHeight-(i+n/2),this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}setZoom(t){this._options.zoom&&t!==this._zoom&&(this._zoom=t,this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop"))}}s.defaults={previewWidth:300,previewHeight:300,maxPreviewWidth:null,maxPreviewHeight:null,maxWidth:null,maxHeight:null,minZoom:.1,maxZoom:10,zoomAmount:.1,circle:!1,exifOrientation:!0,zoom:!0,resize:!1,rotate:!0,enforceBoundary:!0},s.classes={circle:"rounded-circle",container:"position-relative w-100 h-100 overflow-hidden border",outerContainer:"position-relative",preview:"position-absolute top-0 left-0",resize:"position-absolute top-100 start-100"};const o=s.prototype;o.load=function(t,i={}){const{x:s=null,y:o=null,zoom:h=null}=i;return this._rotation=0,this._offsetX=s,this._offsetY=o,this._zoom=h,new Promise(((i,s)=>{this._reader.onerror=s,this._img.onerror=s,this._img.onload=t=>{let s;switch(this._previewWidth=this._options.previewWidth,this._previewHeight=this._options.previewHeight,e.setStyle(this._outerContainer,{width:`${this._previewWidth}px`,height:`${this._previewHeight}px`}),this._canvasWidth=this._img.width,this._canvasHeight=this._img.height,null===this._offsetX&&(this._offsetX=this._canvasWidth/2),null===this._offsetY&&(this._offsetY=this._canvasHeight/2),null===this._zoom&&(this._zoom=Math.min(this._previewWidth/this._canvasWidth,this._previewHeight/this._canvasHeight)),this._orientation){case 2:this._flipped=!0;break;case 3:s=180;break;case 4:this._flipped=!0,s=180;break;case 5:this._flipped=!0,s=270;break;case 6:s=270;break;case 7:this._flipped=!0,s=90;break;case 8:s=90}s&&this._updateRotation(s),this._clampZoom(),this._clampOffset(),this._updatePreviewCanvas(),this._updatePreview(),i()};const o=i=>{this._reader.onload=t=>{this._img.src=this._reader.result},this._reader.readAsDataURL(t)};this._options.exifOrientation?(this._reader.onload=t=>{this._orientation=function(t){const i=new DataView(t),e=(t,e=!1)=>i.getUint16(t,e),s=(t,e=!1)=>i.getUint32(t,e);if(65496!=e(0))return-2;let o=2;for(;o<i.byteLength;){if(e(o+2)<=8)return-1;const t=e(o);if(o+=2,65280&~t)break;if(65505!=t){o+=e(o);continue}if(o+=2,1165519206!=s(o))return-1;o+=6;const i=18761==e(o);o+=s(o+4,i);const h=12*e(o,i);o+=2;for(let t=0;t<h;t+=12)if(274==e(o+t,i))return e(o+t+8,i)}return-1}(this._reader.result),o()},this._reader.readAsArrayBuffer(t)):o()}))},o.result=function(t={}){const{type:i="base64",format:s="png",size:o="viewport",quality:h=1,circle:n=!1,background:a=null}=t,r=e.create("canvas"),_=r.getContext("2d");let c=this._previewWidth,p=this._previewHeight;if("original"===o)c/=this._zoom,p/=this._zoom;else if(e._isObject(o))if(o.width&&o.height)c=o.width,p=o.height;else{const t=c/p;o.width?(c=o.width,p=c/t):o.height&&(p=o.height,c=p*t)}const d=c/p;this._options.maxWidth&&(c=Math.min(c,this._options.maxWidth),p=c/d),this._options.maxHeight&&(p=Math.min(p,this._options.maxHeight),c=p*d),e.setAttribute(r,{width:`${c}px`,height:`${p}px`});const[m,u,l,f]=this.getBounds();return _.drawImage(this._canvas,m,u,l-m,f-u,0,0,c,p),(n||this._options.circle)&&(_.globalCompositeOperation="destination-in",_.beginPath(),_.arc(c/2,p/2,c/2,0,2*Math.PI),_.closePath(),_.fill()),a&&(_.globalCompositeOperation="destination-over",_.fillStyle=a,_.rect(0,0,c,p),_.fill(),_.fillStyle="#000"),_.globalCompositeOperation="source-over",new Promise((t=>{switch(i){case"base64":t(r.toDataURL(`image/${s}`,h));break;case"blob":r.toBlob(t,`image/${s}`,h);break;default:t(r)}}))},o._clampOffset=function(){if(!this._options.enforceBoundary)return;const t=this._previewWidth/(this._canvasWidth*this._zoom)*this._canvasWidth/2,i=this._previewHeight/(this._canvasHeight*this._zoom)*this._canvasHeight/2;this._offsetX=e._clamp(this._offsetX,t,this._canvasWidth-t),this._offsetY=e._clamp(this._offsetY,i,this._canvasHeight-i)},o._clampZoom=function(){if(this._zoom=e._clamp(this._zoom,this._options.minZoom,this._options.maxZoom),!this._options.enforceBoundary)return;const t=Math.max(this._previewWidth/this._canvasWidth,this._previewHeight/this._canvasHeight);this._zoom=Math.max(t,this._zoom)},o._events=function(){let t;const s=e.mouseDragFactory((e=>{if(e.button)return!1;t=i.getPosition(e)}),(s=>{const o=i.getPosition(s);this._offsetX+=(o.x-t.x)/this._zoom,this._offsetY+=(o.y-t.y)/this._zoom,t=o,this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}));e.addEvent(this._container,"mousedown.ui.imagecrop touchstart.ui.imagecrop",s),this._options.resize&&this._eventsResize(),this._options.zoom&&this._eventsZoom()},o._eventsResize=function(){let t;const s=e.mouseDragFactory((e=>{e.stopPropagation(),t=i.getPosition(e)}),(s=>{const o=i.getPosition(s);this._previewWidth+=o.x-t.x,this._previewHeight+=o.y-t.y,t=o,this._resizePreview(this._previewWidth,this._previewHeight),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}));e.addEvent(this._resize,"mousedown.ui.imagecrop",s)},o._eventsZoom=function(){let t;const s=t=>{const s=i.getTouchPositions(t);return e._dist(s[0].x,s[0].y,s[1].x,s[1].y)},o=e.mouseDragFactory((i=>{t=s(i)}),(i=>{const o=s(i),h=o-t;t=o,this._zoom+=h/e._dist(0,0,this._previewWidth,this._previewHeight),this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}),null,{touches:2});e.addEvent(this._container,"touchstart.ui.imagecrop",o),e.addEvent(this._container,"wheel.ui.imagecrop",(t=>{t.preventDefault(),t.deltaY>0?this._zoom-=this._options.zoomAmount:t.deltaY<0&&(this._zoom+=this._options.zoomAmount),this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}))},o._render=function(){this._outerContainer=e.create("div",{class:this.constructor.classes.outerContainer}),this._container=e.create("div",{class:this.constructor.classes.container,style:{boxSizing:"content-box"}}),this._options.circle&&e.addClass(this._container,this.constructor.classes.circle),this._options.resize&&(this._resize=e.create("div",{class:this.constructor.classes.resize,style:{width:"5px",height:"5px",backgroundColor:"black",cursor:"nwse-resize",zIndex:1}}),e.append(this._outerContainer,this._resize)),this._canvas=e.create("canvas",{class:this.constructor.classes.preview,style:{transformOrigin:"0 0"}}),this._context=this._canvas.getContext("2d"),e.append(this._container,this._canvas),e.append(this._outerContainer,this._container),e.append(this._node,this._outerContainer)},o._resizePreview=function(t,i){this._options.maxPreviewWidth&&(t=Math.min(t,this._options.maxPreviewWidth)),this._options.maxPreviewHeight&&(i=Math.min(i,this._options.maxPreviewHeight)),this._options.enforceBoundary?(this._previewWidth=Math.min(t,this._canvasWidth*this._zoom),this._previewHeight=Math.min(i,this._canvasHeight*this._zoom),this._clampOffset()):(this._offsetX+=(t-this._previewWidth)/this._zoom/2,this._offsetY-=(i-this._previewHeight)/this._zoom/2,this._previewWidth=t,this._previewHeight=i),e.setStyle(this._outerContainer,{width:`${this._previewWidth}px`,height:`${this._previewHeight}px`})},o._updatePreview=function(){const t=(-this._canvasWidth+this._offsetX)*this._zoom+this._previewWidth/2,i=(-this._canvasHeight+this._offsetY)*this._zoom+this._previewHeight/2;e.setStyle(this._canvas,{transform:`translate3d(${t}px, ${i}px, 0) scale(${this._zoom})`})},o._updatePreviewCanvas=function(){e.setAttribute(this._canvas,{width:this._canvasWidth,height:this._canvasHeight}),this._context.clearRect(0,0,this._canvasWidth,this._canvasHeight),this._context.save(),this._context.translate(this._canvasWidth/2,this._canvasHeight/2),this._context.rotate(this._rotation*Math.PI/180),this._flipped&&this._context.scale(-1,1),this._context.drawImage(this._img,-this._img.width/2,-this._img.height/2,this._img.width,this._img.height),this._context.restore()},o._updateRotation=function(t){const i=(this._rotation+t)%360;i%180==0?(this._canvasWidth=this._img.width,this._canvasHeight=this._img.height):(this._canvasWidth=this._img.height,this._canvasHeight=this._img.width);const e=i>=this._rotation?i:i+360;for(;this._rotation<e;){const t=this._offsetX,i=this._offsetY;this._rotation%180==0?this._offsetX=this._img.height-i:this._offsetX=this._img.width-i,this._offsetY=t,this._rotation+=90}this._rotation%=360},i.initComponent("imagecrop",s),t.ImageCrop=s}));