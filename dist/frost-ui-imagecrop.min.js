!function(t,i){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=i:i(t)}(window,(function(t){"use strict";if(!t)throw new Error("FrostUI-AuthCode requires a Window.");if(!("UI"in t))throw new Error("FrostUI-AuthCode requires FrostUI.");const i=t.Core,e=t.dom,s=t.UI;class h extends s.BaseComponent{constructor(t,i){super(t,i),this._render(),this._events(),this._img=new Image,this._reader=new FileReader}dispose(){e.remove(this._outerContainer),this._outerContainer=null,this._container=null,this._resize=null,this._canvas=null,this._context=null,this._img=null,super.dispose()}}Object.assign(h.prototype,{getBounds(){const t=this._previewWidth/this._zoom,i=this._previewHeight/this._zoom,e=this._canvasWidth-this._offsetX-t/2,s=this._canvasHeight-this._offsetY-i/2;return[e,s,e+t,s+i]},getOffset(){return[this._offsetX,this._offsetY]},getZoom(){return this._zoom},rotate(t=90){return this._settings.rotate&&0!==t?(this._updateRotation(t),this._clampZoom(),this._updatePreviewCanvas(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop"),this):this},setBounds(t,i,s,h){const o=s-t,a=h-i;return this._settings.resize?this._resizePreview(o*this._zoom,o*this._zoom):this._settings.zoom&&(this._zoom=Math.max(this._previewWidth/o,this._previewHeight/a)),this._offsetX=this._canvasWidth-(t+o/2),this._offsetY=this._canvasHeight-(i+a/2),this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop"),this},setOffset(t,i){return t===this._offsetX&&i===this.offsetY||(this._offsetX=t,this._offsetY=i,this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")),this},setZoom(t){return this._settings.zoom&&t!==this._zoom?(this._zoom=t,this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop"),this):this}}),Object.assign(h.prototype,{_events(){let t;e.addEvent(this._container,"mousedown.ui.imagecrop touchstart.ui.imagecrop",e.mouseDragFactory((i=>{if(i.button)return!1;i.preventDefault(),t=s.getPosition(i)}),(i=>{const h=s.getPosition(i);this._offsetX+=(h.x-t.x)/this._zoom,this._offsetY+=(h.y-t.y)/this._zoom,t=h,this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}))),this._settings.resize&&this._eventsResize(),this._settings.zoom&&this._eventsZoom()},_eventsResize(){let t;e.addEvent(this._resize,"mousedown.ui.imagecrop",e.mouseDragFactory((i=>{i.preventDefault(),i.stopPropagation(),t=s.getPosition(i)}),(i=>{const h=s.getPosition(i);this._previewWidth+=h.x-t.x,this._previewHeight+=h.y-t.y,t=h,this._resizePreview(this._previewWidth,this._previewHeight),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")})))},_eventsZoom(){const t=t=>{const e=s.getTouchPositions(t);return i.dist(e[0].x,e[0].y,e[1].x,e[1].y)};let h;e.addEvent(this._container,"touchstart.ui.imagecrop",e.mouseDragFactory((i=>{h=t(i)}),(s=>{const o=t(s),a=o-h;h=o,this._zoom+=a/i.dist(0,0,this._previewWidth,this._previewHeight),this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}),null,{touches:2})),e.addEvent(this._container,"wheel.ui.imagecrop",(t=>{t.preventDefault(),t.deltaY>0?this._zoom-=this._settings.zoomAmount:t.deltaY<0&&(this._zoom+=this._settings.zoomAmount),this._clampZoom(),this._clampOffset(),this._updatePreview(),e.triggerEvent(this._node,"update.ui.imagecrop")}))}}),Object.assign(h.prototype,{_clampOffset(){if(!this._settings.enforceBoundary)return;const t=this._previewWidth/(this._canvasWidth*this._zoom)*this._canvasWidth/2,e=this._previewHeight/(this._canvasHeight*this._zoom)*this._canvasHeight/2;this._offsetX=i.clamp(this._offsetX,t,this._canvasWidth-t),this._offsetY=i.clamp(this._offsetY,e,this._canvasHeight-e)},_clampZoom(){if(this._zoom=i.clamp(this._zoom,this._settings.minZoom,this._settings.maxZoom),!this._settings.enforceBoundary)return;const t=Math.max(this._previewWidth/this._canvasWidth,this._previewHeight/this._canvasHeight);this._zoom=Math.max(t,this._zoom)},_resizePreview(t,i){this._settings.maxPreviewWidth&&(t=Math.min(t,this._settings.maxPreviewWidth)),this._settings.maxPreviewHeight&&(i=Math.min(i,this._settings.maxPreviewHeight)),this._settings.enforceBoundary?(this._previewWidth=Math.min(t,this._canvasWidth*this._zoom),this._previewHeight=Math.min(i,this._canvasHeight*this._zoom),this._clampOffset()):(this._offsetX+=(t-this._previewWidth)/this._zoom/2,this._offsetY-=(i-this._previewHeight)/this._zoom/2,this._previewWidth=t,this._previewHeight=i),e.setStyle(this._outerContainer,{width:`${this._previewWidth}px`,height:`${this._previewHeight}px`})},_updatePreview(){const t=(-this._canvasWidth+this._offsetX)*this._zoom+this._previewWidth/2,i=(-this._canvasHeight+this._offsetY)*this._zoom+this._previewHeight/2;e.setStyle(this._canvas,"transform",`translate3d(${t}px, ${i}px, 0) scale(${this._zoom})`)},_updatePreviewCanvas(){e.setAttribute(this._canvas,"width",this._canvasWidth),e.setAttribute(this._canvas,"height",this._canvasHeight),this._context.clearRect(0,0,this._canvasWidth,this._canvasHeight),this._context.save(),this._context.translate(this._canvasWidth/2,this._canvasHeight/2),this._context.rotate(this._rotation*Math.PI/180),this._flipped&&this._context.scale(-1,1),this._context.drawImage(this._img,-this._img.width/2,-this._img.height/2,this._img.width,this._img.height),this._context.restore()},_updateRotation(t){const i=(this._rotation+t)%360;i%180==0?(this._canvasWidth=this._img.width,this._canvasHeight=this._img.height):(this._canvasWidth=this._img.height,this._canvasHeight=this._img.width);const e=i>=this._rotation?i:i+360;for(;this._rotation<e;){const t=this._offsetX,i=this._offsetY;this._rotation%180==0?this._offsetX=this._img.height-i:this._offsetX=this._img.width-i,this._offsetY=t,this._rotation+=90}this._rotation%=360}}),Object.assign(h.prototype,{load(t,i={}){const{x:s=null,y:h=null,zoom:o=null}=i;return this._rotation=0,this._offsetX=s,this._offsetY=h,this._zoom=o,new Promise(((i,s)=>{this._reader.onerror=s,this._img.onerror=s,this._img.onload=t=>{let s;switch(this._previewWidth=this._settings.previewWidth,this._previewHeight=this._settings.previewHeight,e.setStyle(this._outerContainer,{width:`${this._previewWidth}px`,height:`${this._previewHeight}px`}),this._canvasWidth=this._img.width,this._canvasHeight=this._img.height,null===this._offsetX&&(this._offsetX=this._canvasWidth/2),null===this._offsetY&&(this._offsetY=this._canvasHeight/2),null===this._zoom&&(this._zoom=Math.min(this._previewWidth/this._canvasWidth,this._previewHeight/this._canvasHeight)),this._orientation){case 2:this._flipped=!0;break;case 3:s=180;break;case 4:this._flipped=!0,s=180;break;case 5:this._flipped=!0,s=270;break;case 6:s=270;break;case 7:this._flipped=!0,s=90;break;case 8:s=90}s&&this._updateRotation(s),this._clampZoom(),this._clampOffset(),this._updatePreviewCanvas(),this._updatePreview(),i()};const h=i=>{this._reader.onload=t=>{this._img.src=this._reader.result},this._reader.readAsDataURL(t)};this._settings.exifOrientation?(this._reader.onload=t=>{this._orientation=this.constructor._getOrientation(this._reader.result),h()},this._reader.readAsArrayBuffer(t)):h()}))}}),Object.assign(h.prototype,{_render(){this._outerContainer=e.create("div",{class:this.constructor.classes.outerContainer}),this._container=e.create("div",{class:this.constructor.classes.container}),this._settings.circle&&e.addClass(this._container,this.constructor.classes.circle),this._settings.resize&&(this._resize=e.create("div",{class:this.constructor.classes.resize,style:{width:"5px",height:"5px",backgroundColor:"black",cursor:"nwse-resize",zIndex:1}}),e.append(this._outerContainer,this._resize)),this._canvas=e.create("canvas",{class:this.constructor.classes.preview,style:{transformOrigin:"0 0"}}),this._context=this._canvas.getContext("2d"),e.append(this._container,this._canvas),e.append(this._outerContainer,this._container),e.append(this._node,this._outerContainer)}}),Object.assign(h.prototype,{result(t={}){const{type:s="base64",format:h="png",size:o="viewport",quality:a=1,circle:r=!1,background:n=null}=t,_=e.create("canvas"),c=_.getContext("2d");let g=this._previewWidth,d=this._previewHeight;if("original"===o)g/=this._zoom,d/=this._zoom;else if(i.isObject(o))if(o.width&&o.height)g=o.width,d=o.height;else{const t=g/d;o.width?(g=o.width,d=g/t):o.height&&(d=o.height,g=d*t)}const p=g/d;this._settings.maxWidth&&(g=Math.min(g,this._settings.maxWidth),d=g/p),this._settings.maxHeight&&(d=Math.min(d,this._settings.maxHeight),g=d*p),e.setAttribute(_,"width",`${g}px`),e.setAttribute(_,"height",`${d}px`);const[m,l,u,v]=this.getBounds();return c.drawImage(this._canvas,m,l,u-m,v-l,0,0,g,d),(r||this._settings.circle)&&(c.globalCompositeOperation="destination-in",c.beginPath(),c.arc(g/2,d/2,g/2,0,2*Math.PI),c.closePath(),c.fill()),n&&(c.globalCompositeOperation="destination-over",c.fillStyle=n,c.rect(0,0,g,d),c.fill(),c.fillStyle="#000"),c.globalCompositeOperation="source-over",new Promise((t=>{switch(s){case"base64":t(_.toDataURL(`image/${h}`,a));break;case"blob":_.toBlob(t,`image/${h}`,a);break;default:t(_)}}))}}),Object.assign(h,{_getOrientation(t){const i=new DataView(t),e=(t,e=!1)=>i.getUint16(t,e),s=(t,e=!1)=>i.getUint32(t,e);if(65496!=e(0))return-2;let h=2;for(;h<i.byteLength;){if(e(h+2)<=8)return-1;const t=e(h);if(h+=2,65280!=(65280&t))break;if(65505!=t){h+=e(h);continue}if(h+=2,1165519206!=s(h))return-1;h+=6;const i=18761==e(h);h+=s(h+4,i);const o=12*e(h,i);h+=2;for(let t=0;t<o;t+=12)if(274==e(h+t,i))return e(h+t+8,i)}return-1}}),h.defaults={previewWidth:300,previewHeight:300,maxPreviewWidth:null,maxPreviewHeight:null,maxWidth:null,maxHeight:null,minZoom:.1,maxZoom:10,zoomAmount:.1,circle:!1,exifOrientation:!0,zoom:!0,resize:!1,rotate:!0,enforceBoundary:!0},h.classes={circle:"rounded-circle",container:"position-relative w-100 h-100 overflow-hidden border",outerContainer:"position-relative",preview:"position-absolute top-0 left-0",resize:"position-absolute top-100 start-100 translate-middle"},s.initComponent("imagecrop",h),s.ImageCrop=h}));